name: Keep Warm - Scheduled Ping

on:
  schedule:
    - cron: '*/10 * * * *'  # Every 10 minutes, 24/7
  workflow_dispatch:

jobs:
  ping-prod:
    runs-on: ubuntu-latest
    steps:
      - name: Ping PROD Health Endpoint
        id: health-check-prod
        run: |
          echo "Pinging PRODUCTION to keep warm..."
          
          # Perform health check with timeout
          START_TIME=$(date +%s)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 https://${{ vars.PROD_API_URL }}/spartan/health || echo "000")
          END_TIME=$(date +%s)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          echo "PROD Response: $HTTP_STATUS (${RESPONSE_TIME}s)"
          echo "response_code=$HTTP_STATUS" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "? PROD is healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          elif [ "$HTTP_STATUS" = "503" ] || [ "$HTTP_STATUS" = "000" ]; then
            echo "?? PROD returned $HTTP_STATUS (may be waking up or unavailable)"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "? PROD returned unexpected status: $HTTP_STATUS"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Alert on PROD Failure via Brevo API
        if: steps.health-check-prod.outputs.status == 'unhealthy'
        run: |
          curl -X POST "https://api.brevo.com/v3/smtp/email" \
            -H "accept: application/json" \
            -H "api-key: ${{ secrets.BREVO_API_KEY }}" \
            -H "content-type: application/json" \
            -d '{
              "sender": {
                "name": "SpartanGym Monitoring",
                "email": "gymnastics.backend@gmail.com"
              },
              "to": [
                {
                  "email": "${{ secrets.ALERT_EMAIL }}",
                  "name": "Admin"
                }
              ],
              "subject": "?? SpartanGym PROD Health Check Failed",
              "htmlContent": "<html><body><h2>?? PRODUCTION Environment Health Check Failed</h2><table style=\"border-collapse: collapse; width: 100%;\"><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Environment</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">PRODUCTION</td></tr><tr><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>URL</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">https://${{ vars.PROD_API_URL }}/spartan/health</td></tr><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Status Code</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ steps.health-check-prod.outputs.response_code }}</td></tr><tr><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Response Time</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ steps.health-check-prod.outputs.response_time }}s</td></tr><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Timestamp</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ github.event.repository.updated_at }}</td></tr></table><h3>Action Required:</h3><ol><li>Check Azure Container Apps health in Azure Portal</li><li>Review Application Insights logs</li><li>Verify database connectivity</li><li>Check recent deployments</li></ol><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow Run</a></p></body></html>"
            }'

      - name: Create PROD Health Summary
        run: |
          echo "## ?? PROD Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.health-check-prod.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Response Code:** ${{ steps.health-check-prod.outputs.response_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Response Time:** ${{ steps.health-check-prod.outputs.response_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://${{ vars.PROD_API_URL }}/spartan/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  ping-test:
    runs-on: ubuntu-latest
    steps:
      - name: Ping TEST Health Endpoint
        id: health-check-test
        run: |
          echo "Pinging TEST to keep warm..."
          
          # Perform health check with timeout
          START_TIME=$(date +%s)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 https://${{ vars.TEST_API_URL }}/spartan/health || echo "000")
          END_TIME=$(date +%s)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          echo "TEST Response: $HTTP_STATUS (${RESPONSE_TIME}s)"
          echo "response_code=$HTTP_STATUS" >> $GITHUB_OUTPUT
          echo "response_time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "? TEST is healthy"
            echo "status=healthy" >> $GITHUB_OUTPUT
          elif [ "$HTTP_STATUS" = "503" ] || [ "$HTTP_STATUS" = "000" ]; then
            echo "?? TEST returned $HTTP_STATUS (may be waking up or unavailable)"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "? TEST returned unexpected status: $HTTP_STATUS"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Alert on TEST Failure via Brevo API
        if: steps.health-check-test.outputs.status == 'unhealthy'
        run: |
          curl -X POST "https://api.brevo.com/v3/smtp/email" \
            -H "accept: application/json" \
            -H "api-key: ${{ secrets.BREVO_API_KEY }}" \
            -H "content-type: application/json" \
            -d '{
              "sender": {
                "name": "SpartanGym Monitoring",
                "email": "gymnastics.backend@gmail.com"
              },
              "to": [
                {
                  "email": "${{ secrets.ALERT_EMAIL }}",
                  "name": "Admin"
                }
              ],
              "subject": "?? SpartanGym TEST Health Check Failed",
              "htmlContent": "<html><body><h2>?? TEST Environment Health Check Failed</h2><table style=\"border-collapse: collapse; width: 100%;\"><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Environment</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">TEST</td></tr><tr><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>URL</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">https://${{ vars.TEST_API_URL }}/spartan/health</td></tr><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Status Code</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ steps.health-check-test.outputs.response_code }}</td></tr><tr><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Response Time</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ steps.health-check-test.outputs.response_time }}s</td></tr><tr style=\"background-color: #f2f2f2;\"><td style=\"border: 1px solid #ddd; padding: 8px;\"><strong>Timestamp</strong></td><td style=\"border: 1px solid #ddd; padding: 8px;\">${{ github.event.repository.updated_at }}</td></tr></table><h3>Action Required:</h3><ol><li>Check Azure Container Apps health in Azure Portal</li><li>Review Application Insights logs</li><li>Verify database connectivity</li><li>Check recent deployments</li></ol><p><a href=\"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\">View Workflow Run</a></p></body></html>"
            }'

      - name: Create TEST Health Summary
        run: |
          echo "## ?? TEST Health Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.health-check-test.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Response Code:** ${{ steps.health-check-test.outputs.response_code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Response Time:** ${{ steps.health-check-test.outputs.response_time }}s" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://${{ vars.TEST_API_URL }}/spartan/health" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [ping-prod, ping-test]
    if: always()
    steps:
      - name: Overall Health Summary
        run: |
          echo "# ?? SpartanGym Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** Keep-Warm Scheduled Ping" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "? Keep-warm pings completed for both environments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> Note: Individual environment health details are available in job summaries above." >> $GITHUB_STEP_SUMMARY
